# Security & Scalability Deep Dive

How we addressed the core security and scalability requirements.

## Secrets Management

### Implementation

**AWS Secrets Manager + External Secrets:**
- **Centralized storage** - All sensitive data in AWS Secrets Manager
- **Auto-sync** - External Secrets Operator syncs to Kubernetes
- **No hardcoded secrets** - Zero secrets in code or containers
- **Encryption at rest** - KMS encryption for all secrets

**What we store securely:**
- JWT tokens for Supabase authentication
- RDS master password (auto-generated by AWS)
- Dashboard credentials
- Analytics API keys

**Rotation ready:**
- Infrastructure supports automatic secret rotation
- External Secrets can detect and sync changes
- Applications restart automatically on secret updates

## Least Privilege

### AWS IAM Implementation

**IRSA (IAM Roles for Service Accounts):**
- **No AWS keys in pods** - Each service uses temporary credentials
- **Minimal permissions** - Each role has only necessary permissions
- **Service-specific roles** - Storage service only accesses S3, etc.

**External Secrets role:**
- Only `secretsmanager:GetSecretValue` permission
- Scoped to specific secret ARNs
- No other AWS permissions granted

### Kubernetes RBAC

**Service accounts:**
- Each Supabase service has dedicated service account
- Minimal cluster permissions
- ArgoCD isolated in separate namespace

**Role bindings:**
- Services can only access their own secrets
- No cluster-admin permissions
- Principle of least privilege enforced

## Network Security

### Multi-Layer Defense

**VPC isolation:**
- **Private subnets** - All workloads isolated from internet
- **Public subnets** - Only load balancers and NAT gateways
- **Security groups** - Least privilege network access
- **NACLs** - Additional subnet-level protection

**Kubernetes NetworkPolicies:**
- **Ingress control** - Pods only accept necessary traffic
- **Egress control** - All egress allowed (simplified for demo)
- **Service isolation** - Each service has dedicated policy
- **Calico enforcement** - Policy-only mode for NetworkPolicy support

**Traffic flow:**
```
Internet → ALB → Kong Gateway → Supabase Services → Private RDS
                                              → S3 (via IRSA)
```

**Database security:**
- **Private RDS** - Never accessible from internet
- **VPC-only access** - Only from EKS cluster
- **Encrypted connections** - SSL/TLS enforced
- **Security group** - Port 5432 only from cluster

## Scalability Considerations

### Horizontal Pod Autoscaler

**Auto-scaling configuration:**
- **Auth** - 1-5 replicas based on CPU (70% threshold)
- **PostgREST** - 1-10 replicas (handles most traffic)
- **Realtime** - 1-5 replicas based on CPU
- **Storage** - 1-3 replicas based on CPU
- **Kong** - 1-5 replicas for load balancing

**Metrics Server:**
- Provides CPU/memory metrics for HPA decisions
- Enables automatic scaling based on resource usage

### Cluster Autoscaler

**Node scaling:**
- **2-10 nodes** - Scales based on pod resource requests
- **Multi-AZ** - Nodes distributed across availability zones
- **Instance types** - t3.large (cost-optimized, can scale up)
- **Automatic cleanup** - Removes unused nodes

### Database Scalability

**RDS Multi-AZ:**
- **High availability** - Automatic failover in under 60 seconds
- **Read replicas** - Can add for read-heavy workloads
- **Storage auto-scaling** - Grows automatically when needed
- **Backup strategy** - 7-day retention with point-in-time recovery

### Storage Scalability

**S3 integration:**
- **Unlimited capacity** - Scales automatically
- **Multi-part uploads** - Handles large files efficiently
- **Cross-region replication** - Can be enabled for DR
- **Intelligent tiering** - Automatic cost optimization
